/**
 * @name car-service
 * @description Easy and convenient way to register cars and their repairs.
 *
 * @version 1.0.0
 * @author Eleonora Atanasova
 * @license Apache-2.0
 */
var e,t,a,r,n,o,s,i=(e,t,a)=>{if(!t.has(e))throw TypeError("Cannot "+a)},c=(e,t,a)=>(i(e,t,"read from private field"),a?a.call(e):t.get(e)),l=(e,t,a)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,a)},d=(e,t,a)=>(i(e,t,"access private method"),a);import{D as u,x as p,p as m,C as f,r as g,A as b,m as h,E as y,a as v}from"./vendor.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();async function w(e,t){const a=new URL(e,"https://parseapi.back4app.com"),r=await fetch(a,t);if(!0!==r.ok){r.status>=400&&r.status<500&&await Z();const e=await r.json();throw new Error(`${e.message||e.error} Status: ${r.status}`,{cause:r})}return r.json()}function $(e,t){const a=new Headers({"X-Parse-Application-Id":"n4ufAUz9mhrjYKPDalloTzaHgwQxCzyclvXVLszh","X-Parse-REST-API-Key":"cRIv7Kag8w1bQvcXWXvj6qXeCghzgoLPm77xmGKb"}),r=X();return r&&a.append("X-Parse-Session-Token",r.token),t&&a.append("Content-Type","application/json"),{method:e,headers:a,...t?{body:JSON.stringify(t)}:{}}}const _=e=>w(e,$("GET")),C=(e,t)=>w(e,$("POST",t)),x=(e,t)=>w(e,$("PUT",t)),k=e=>w(e,$("DELETE")),I=new Map;function N(e){if(!e)return{};try{return decodeURIComponent(e).split("&").reduce(((e,t)=>{const[a,r]=t.split("=");return e[a.trim()]=(null==r?void 0:r.includes(","))?r.split(",").map(decodeURIComponent):decodeURIComponent(null==r?void 0:r.trim()),e}),{})}catch(t){return console.error(t),{}}}function D(e){if(!e)return"";try{return Object.entries(e).filter((([e,t])=>{const a="string"==typeof e&&e.trim().length>0,r="string"==typeof t?t.trim().length>0:Array.isArray(t)&&t.every((e=>"string"==typeof e&&e.trim().length>0));return a&&r})).map((([e,t])=>{const a=Array.isArray(t)?t.map((e=>encodeURIComponent(e.trim()))).join(","):encodeURIComponent(t.trim());return`${encodeURIComponent(e.trim())}=${a}`})).join("&")}catch(t){return console.error(t),""}}function S(e){const t=new FormData(e);return[Object.fromEntries(Array.from(t,(([e,t])=>[e,"string"==typeof t?t.trim():t]))),t=>Array.from(e.elements).forEach((e=>t?e.setAttribute("disabled","true"):e.removeAttribute("disabled")))]}function A(){if(crypto&&crypto.randomUUID)return crypto.randomUUID();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=~~(16*Math.random());return("x"===e?t:3&t|8).toString(16)}))}function R(e,t={}){const{parent:a,prepend:r=!1,attributes:n,children:o,style:s,...i}=t,c=document.createElement(e);if(void 0!==n)for(const l in n)c.setAttribute(l,n[l]);if(Array.isArray(o))for(const l of o)c.append(l);if(void 0!==s&&Object.assign(c.style,s),Object.assign(c,i),void 0!==a){const e="string"==typeof a?document.querySelector(a):a;e&&e[r?"prepend":"append"](c)}return c}const P=new Intl.NumberFormat("bg-BG",{style:"currency",currency:"BGN"});function L(e){return P.format(parseFloat(e||"0"))}function E(e,t="bg-BG"){try{const a=6e4*(new Date).getTimezoneOffset(),r=Number(new Date(e))+a;return Intl.DateTimeFormat(t).format(r)}catch{return e.toString()}}function T(e){return`${e}T${function(e){const t=6e4*(new Date).getTimezoneOffset(),a=e&&Number(new Date(e).getTime()+t)||Date.now(),r=new Date(a-t).toISOString();return r.split("T")[1].slice(0,-5)}()}.000Z`}function j(e=Date.now()){const t=6e4*(new Date).getTimezoneOffset(),a=Number(new Date(e).getTime()+t);return new Date(a-t).toISOString().split("T")[0]}const O={storageKeys:{userService:"car-service-current-user-data",memoization:"car-service-cache-initialized"},itemsPerPage:10,usersPerPage:5,relativePageLinks:3};e=new WeakMap;const q=new class{constructor(t){var a,r,n,o;l(this,e,void 0),n=t,i(a=this,r=e,"write to private field"),o?o.call(a,n):r.set(a,n),window.caches||console.warn("Cache API is not supported in this environment"),!sessionStorage.getItem(O.storageKeys.memoization)&&this.supported&&(sessionStorage.setItem(O.storageKeys.memoization,"true"),this.deleteCache())}get supported(){const e=X();return!!window.caches&&!!e&&!e.isSuperUser}get databaseName(){return c(this,e)}async getCacheData(t){if(!this.supported)return Promise.resolve(null);const a=await caches.open(c(this,e)),r=await a.match(new Request(t));return r&&r.ok?await r.json():Promise.resolve(null)}async updateCacheData(t,a){if(!this.supported)return Promise.resolve();return(await caches.open(c(this,e))).put(new Request(t),new Response(JSON.stringify(a)))}async clearCacheData(t){if(!this.supported)return Promise.resolve(!1);return(await caches.open(c(this,e))).delete(new Request(t))}async deleteCache(){return this.supported?caches.delete(c(this,e)):Promise.resolve(!1)}}("CarServiceCacheDatabase"),M="rgba(0 0 0 / 0.5)",V=3,z={default:{icon:"",color:"#555555",backgroundColor:"#f2f2f2"},info:{icon:"info",color:"#217ca3",backgroundColor:"#cfe8f3"},success:{icon:"check_circle",color:"#45874a",backgroundColor:"#e5f6e4"},warning:{icon:"error",color:"#b0822f",backgroundColor:"#fef5dc"},error:{icon:"cancel",color:"#b23c3a",backgroundColor:"#f2dede"}};t=new WeakMap,a=new WeakSet,r=function(e,t){switch(e){case"cube-flip":return R("div",{className:"notice-loading-cube-flip",style:{backgroundColor:t}});case"dots-zoom":return R("div",{className:"notice-loading-dots-zoom",children:[R("div",{className:"notice-loading-dots-zoom1",style:{backgroundColor:t}}),R("div",{className:"notice-loading-dots-zoom2",style:{backgroundColor:t}})]});case"line":return R("div",{className:"notice-loading-line",children:[R("div",{className:"notice-loading-line-rect1",style:{backgroundColor:t}}),R("div",{className:"notice-loading-line-rect2",style:{backgroundColor:t}}),R("div",{className:"notice-loading-line-rect3",style:{backgroundColor:t}}),R("div",{className:"notice-loading-line-rect4",style:{backgroundColor:t}}),R("div",{className:"notice-loading-line-rect5",style:{backgroundColor:t}})]});case"dots-spin":return R("div",{className:"notice-loading-spin-dots",children:[R("div",{className:"notice-loading-spin-dot1",style:{backgroundColor:t}}),R("div",{className:"notice-loading-spin-dot2",style:{backgroundColor:t}})]});case"dots":return R("div",{className:"notice-loading-dots",children:[R("div",{className:"notice-loading-dot1",style:{backgroundColor:t}}),R("div",{className:"notice-loading-dot2",style:{backgroundColor:t}}),R("div",{style:{backgroundColor:t}})]});case"cube-zoom":return R("div",{className:"notice-loading-cube-zoom",children:[R("div",{className:"notice-loading-cube-zoom-1",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-2",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-3",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-4",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-5",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-6",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-7",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-8",style:{backgroundColor:t}}),R("div",{className:"notice-loading-cube-zoom-9",style:{backgroundColor:t}})]});default:return null}},n=new WeakSet,o=function(e,t,a,r){const n=R("div",{className:"notice-modal-buttons"});switch(e){case"yes-no":return R("button",{parent:n,attributes:{"data-button-type":"info"},textContent:"Да",onclick:e=>{t.remove(),"function"==typeof a&&a(e)}}),R("button",{parent:n,attributes:{"data-button-type":"danger"},textContent:"Не",onclick:e=>{t.remove(),"function"==typeof r&&r(e)}}),n;case"ok":return R("button",{parent:n,textContent:"Добре",onclick:e=>{t.remove(),"function"==typeof a&&a(e)}}),n;case"ok-cancel":return R("button",{parent:n,textContent:"Добре",onclick:e=>{t.remove(),"function"==typeof a&&a(e)}}),R("button",{parent:n,attributes:{"data-button-type":"danger"},textContent:"Отказ",onclick:e=>{t.remove(),"function"==typeof r&&r(e)}}),n;case"retry-cancel":return R("button",{parent:n,attributes:{"data-button-type":"info"},textContent:"Нов опит",onclick:e=>{t.remove(),"function"==typeof a&&a(e)}}),R("button",{parent:n,attributes:{"data-button-type":"danger"},textContent:"Отказ",onclick:e=>{t.remove(),"function"==typeof r&&r(e)}}),n;default:return null}};const U=new class{constructor(){l(this,a),l(this,n),l(this,t,document.body)}showLoading(e={}){const{type:n="dots",color:o="white",autoClose:s,title:i,titleColor:l,maskColor:u=M}=e,p=R("div",{parent:c(this,t),className:"notice-loading notice-flex-center notice-fixed-all-page",id:"notice-loading"});R("div",{parent:p,className:"notice-mask notice-fixed-all-page",style:{backgroundColor:u}});const m=d(this,a,r).call(this,n,o)||d(this,a,r).call(this,"dots",o),f=R("div",{parent:p,className:"notice-flex-center notice-loading-main",children:[m]});i&&R("p",{parent:f,style:{color:l},textContent:i}),s&&setTimeout((()=>p.remove()),1e3*s)}hideLoading(){var e;null==(e=document.getElementById("notice-loading"))||e.remove()}showToast(e){const{text:a,type:r="default",autoClose:n=V,showClose:o=!0}=e;if(!a)return;const{icon:s,color:i,backgroundColor:l}=z[r]||z.default,d=document.getElementById("notice-toast")||R("div",{parent:c(this,t),className:"notice-toast",id:"notice-toast"}),u=R("div",{parent:d,className:"notice-toast-main notice-toast-main-active",id:`notice-toast-${A()}`,style:{backgroundColor:l}}),p=R("div",{parent:u,className:"notice-toast-container",children:[R("p",{className:"notice-toast-text",style:{color:i},textContent:a})]});s&&R("i",{parent:p,prepend:!0,className:"material-icons notice-toast-icon",style:{color:i},textContent:s}),(o||!n)&&R("i",{parent:p,className:"material-icons notice-close-icon",textContent:"close",onclick:()=>f()});const m=!!Number(getComputedStyle(d).getPropertyValue("--_should-auto-close"));if(n||m){setTimeout((()=>f()),1e3*(n||V))}function f(){if(!u)return;const e=parseFloat(window.getComputedStyle(u).getPropertyValue("transition-duration"));u.classList.remove("notice-toast-main-active"),setTimeout((()=>{u&&u.remove(),d.children.length||d.remove()}),1e3*e)}}showModal(e={}){const{type:a="yes-no",color:r,backgroundColor:s,title:i,titleColor:l,message:u,messageColor:p,maskColor:m=M,onConfirm:f,onCancel:g}=e,b=R("div",{parent:c(this,t),className:"notice-modal notice-flex-center notice-fixed-all-page",id:"notice-modal"});R("div",{parent:b,className:"notice-mask notice-fixed-all-page",style:{backgroundColor:m}});const h=R("div",{parent:b,className:"notice-flex-center notice-modal-main",style:{backgroundColor:s},children:[d(this,n,o).call(this,a,b,f,g)||d(this,n,o).call(this,"yes-no",b,f,g)]});u&&R("p",{parent:h,prepend:!0,style:{color:p||r},textContent:u}),i&&R("h2",{parent:h,prepend:!0,style:{color:l||r},textContent:i})}},J=document.querySelectorAll(".admin-navigation"),B=document.querySelectorAll(".user-navigation"),F=document.querySelectorAll(".guest-navigation");function H(e){const t=X(),a=t&&t.isSuperUser,r=e&&e.pathname.includes("/cars");J.forEach((e=>{a?e.removeAttribute("hidden"):e.setAttribute("hidden","")})),B.forEach((n=>{t&&!a||a&&r?(n.removeAttribute("hidden"),a&&r&&function(e){const t="/Car-Service";B.forEach((a=>{Array.from(a.children).forEach((a=>{const r=a.firstChild,n=r.getAttribute("href")||"";if(r.id||n.includes("/admin"))return;const o=`${e.page.base()}${n.replace(t,"")}`;r.setAttribute("href",o)}))}))}(e)):a||n.setAttribute("hidden","")})),F.forEach((e=>{t?e.setAttribute("hidden",""):e.removeAttribute("hidden")}))}const W={LOGIN:"/functions/loginWithRoles",REGISTER:"/users",LOGOUT:"/logout",ALL_USERS:"/functions/getAllUsersWithRoles"},Y={CREATE_CAR:"/classes/Car",ALL_CARS:(e="")=>`/classes/Car?${D({order:"-createdAt",where:e,include:"owner"})}`,CAR_BY_ID:e=>`/classes/Car/${e}`},G={CREATE_REPAIR:"/classes/Repair",ALL_REPAIRS_BY_CAR:e=>`/classes/Repair?${D({order:"-date",where:e})}`,ALL_REPAIRS:(e={})=>`/classes/Repair?${D({order:"-date",include:"owner",...e})}`,REPAIR_BY_ID:e=>`/classes/Repair/${e}`};async function K(e){const t=await C(W.ALL_USERS,{}),{result:a}=t,r=a.filter((e=>!e.roles.includes("Admin"))).sort(((e,t)=>Number(new Date(t.createdAt))-Number(new Date(e.createdAt))));if(!e)return{results:r,count:r.length};const n=(e-1)*O.usersPerPage,o=e*O.usersPerPage;return{results:r.slice(n,o),count:r.length}}function X(){var e;return JSON.parse(null!=(e=sessionStorage.getItem(O.storageKeys.userService))?e:"null")}async function Q(e){await q.deleteCache().catch(console.error),sessionStorage.setItem(O.storageKeys.userService,JSON.stringify(e))}async function Z(){await q.deleteCache().catch(console.error),sessionStorage.removeItem(O.storageKeys.userService)}async function ee(e){const t="/cars",a=await q.getCacheData(t),r=a&&a.find((t=>t.objectId===e));if(r)return r;const n=await _(Y.CAR_BY_ID(e));if(a){const e=[n,...a].sort(((e,t)=>+new Date(t.createdAt)-+new Date(e.createdAt)));await q.updateCacheData(t,JSON.parse(JSON.stringify(e)))}return n}async function te(e){var t;const a=await k(Y.CAR_BY_ID(e)),r="/cars",n=(null!=(t=await q.getCacheData(r))?t:[]).filter((t=>t.objectId!==e));return await(n.length>0?q.updateCacheData(r,JSON.parse(JSON.stringify(n))):q.clearCacheData(r)),a}const ae=(e,t)=>{const a=Number(new Date(e.date))||Number(new Date(e.createdAt));return(Number(new Date(t.date))||Number(new Date(t.createdAt)))-a};async function re(e,t){const a=JSON.stringify({car:{__type:"Pointer",className:"Car",objectId:e}}),r=`/cars/${e}/repairs`,n=await q.getCacheData(r);let o;if(n?o=n:(({results:o}=await _(G.ALL_REPAIRS_BY_CAR(a))),await q.updateCacheData(r,JSON.parse(JSON.stringify(o)))),!t)return{results:o,all:o};const s=10*(t-1),i=10*t;return{results:o.slice(s,i),all:o}}async function ne(e,t){const a=`/cars/${e}/repairs`,r=await q.getCacheData(a),n=r&&r.find((e=>e.objectId===t));if(n)return n;const o=await _(G.REPAIR_BY_ID(t));if(r){const e=[o,...r].sort(ae);await q.updateCacheData(a,JSON.parse(JSON.stringify(e)))}return o}async function oe(e){const{results:t}=await re(e),a=t.map((({objectId:e})=>k(G.REPAIR_BY_ID(e)))),r=`/cars/${e}/repairs`;return await q.clearCacheData(r),Promise.all(a)}const se=document.getElementById("site-content")||document.body,ie=document.querySelector("meta[name=viewport]"),ce=["/user/login","/user/register"],le=["/cars","/repairs"],de=["/admin"];function ue(e,t={}){const{container:a,...r}=t,n=a&&(a instanceof HTMLElement||a instanceof DocumentFragment)?a:"string"==typeof a?document.querySelector(a):null;return u(e,n||se,r)}const pe={today:{label:"Днес",startDate:fe(0),endDate:null},last_7_days:{label:"Последните 7 дни",startDate:fe(6),endDate:null},last_30_days:{label:"Последните 30 дни",startDate:fe(29),endDate:null},last_90_days:{label:"Последните 90 дни",startDate:fe(89),endDate:null},last_365_days:{label:"Последните 365 дни",startDate:fe(364),endDate:null},all_time:{label:"Всички",startDate:null,endDate:null}};function me(e,t,a){if(e)return pe[e];const r=new Date(t||""),n=new Date(a||"");return ge(r)&&ge(n)?{label:`${j(r)} - ${j(n)}`,startDate:r,endDate:n}:void 0}function fe(e){const t=new Date;return t.setDate(t.getDate()-e),t.setHours(0,0,0,0),t}function ge(e){return!(!(e instanceof Date||"object"==typeof e&&"[object Date]"===Object.prototype.toString.call(e))&&"number"!=typeof e)&&!isNaN(Number(new Date(e)))}f.register(...g);const be=(e,t)=>{const a=document.createElement("canvas");return new f(a,{type:"pie",data:{labels:e,datasets:[{data:t,label:"Печалба",..._e}]},options:Ce}),a},he=(e,t)=>{const a=document.createElement("canvas");return new f(a,{type:"bar",data:{labels:e,datasets:[{data:t,label:"Ремонти",..._e}]},options:xe}),a},ye=(e,t,a)=>p`<select class="dropdown" @change=${a=>e(a,t)}>${Object.entries(pe).map((([e,{label:t}])=>p`<option .selected=${a===e} value=${e}>${t}</option>`))}</select>`,ve=(e,t)=>p`<table role="table"><thead role="rowgroup"><tr role="row"><th role="columnheader">Потребителско име</th><th role="columnheader">Преглед като потребител</th></tr></thead><tbody role="rowgroup">${e.map((e=>we(e,t)))}</tbody></table>`,we=(e,t)=>p`<tr role="row"><td role="cell" data-cell-content="Име">${e.username}</td><td role="cell" data-cell-content="Разглеждайте"><div class="buttons"><button data-button-type="success" @click=${a=>t(a,e)}><i class="material-icons">person_search</i></button></div></td></tr>`,$e=(e,t)=>{const a=(a,r)=>{const n=e===r||r<1||r>t,o="number"==typeof a&&e===r,s=n?"#":(e=>{const t=D({page:e.toString()});return`${window.location.pathname}?${t}`})(r);return p`<a .href=${s} .className=${`${n?"not-selectable":""} ${o?"active":""}`}>${a}</a>`};const r=a(p`<i class="material-icons">keyboard_double_arrow_left</i>`,1),n=a(p`<i class="material-icons">chevron_left</i>`,e-1),o=function(){const a=Math.floor(O.relativePageLinks/2),r=Math.min(Math.max(1,e-a),Math.max(1,t-O.relativePageLinks+1)),n=Math.max(Math.min(t,e+a),Math.min(t,O.relativePageLinks)),o=Math.min(n-r+1,t);return Array.from({length:o},((e,t)=>r+t))}().map((e=>a(e,e))),s=a(p`<i class="material-icons">chevron_right</i>`,e+1),i=a(p`<i class="material-icons">keyboard_double_arrow_right</i>`,t);return p`${r}${n}${o}${s}${i}`},_e={backgroundColor:["rgba(255, 99, 132, 0.2)","rgba(54, 162, 235, 0.2)","rgba(255, 206, 86, 0.2)","rgba(75, 192, 192, 0.2)","rgba(153, 102, 255, 0.2)","rgba(255, 159, 64, 0.2)","rgba(201, 203, 207, 0.2)"],borderColor:["rgba(255, 99, 132, 1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(201, 203, 207, 1)"],borderWidth:1},Ce={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:"Печалба на потребителите"},tooltip:{callbacks:{label:e=>{const t=e.label||"",a=e.parsed||0,r=(a/e.dataset.data.reduce(((e,t)=>e+t),0)*100).toFixed(2);return`${t}: ${L(a.toString())} (${r}%)`}}}}},xe={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:"Брой ремонти на потребителите"}},scales:{y:{ticks:{stepSize:1},title:{display:!0,text:"Брой ремонти"}},x:{title:{display:!0,text:"Потребители"}}}},ke=(e,t)=>e.length>0?Ie(e,t):p`<p class="empty">Нямаш добавени автомобили!</p>`,Ie=(e,t)=>{var a;const r=!!(null==(a=X())?void 0:a.isSuperUser);return p`<table role="table"><thead role="rowgroup"><tr role="row"><th role="columnheader">Рама</th><th role="columnheader">Pегистрационен &numero;</th><th role="columnheader">Марка / Модел</th><th role="columnheader">Двигател</th><th role="columnheader">Име на клиента</th><th role="columnheader">Ремонти</th><th role="columnheader">Редакция</th>${r?p`<th role="columnheader">Изтриване</th>`:b}</tr></thead><tbody role="rowgroup">${e.map((e=>Ne(e,r,t)))}</tbody></table>`},Ne=(e,t,a)=>p`<tr role="row"><td role="cell" data-cell-content="Рама">${e.vin}</td><td role="cell" data-cell-content="Pегистрационен &numero;">${e.registration}</td><td role="cell" data-cell-content="Марка / Модел">${e.make}</td><td role="cell" data-cell-content="Двигател">${e.engine}</td><td role="cell" data-cell-content="Име на клиента">${e.customerName}</td><td role="cell" data-cell-content="Ремонти"><div class="buttons"><a role="button" data-button-type="info" href="${m.base()}/cars/${e.objectId}/repairs"><i class="material-icons">car_repair</i></a></div></td><td role="cell" data-cell-content="Редакция"><div class="buttons"><a role="button" href="${m.base()}/cars/${e.objectId}/edit"><i class="material-icons">edit</i></a></div></td>${t?De(e,a):b}</tr>`,De=(e,t)=>p`<td role="cell" data-cell-content="Изтриване"><div class="buttons"><button data-button-type="danger" @click=${a=>t(a,e)}><i class="material-icons">delete_forever</i></button></div></td>`,Se=(e,t,a,r)=>{const n=(n,o)=>{const s=e===o||o<1||o>t,i="number"==typeof n&&e===o,c=s?"#":(e=>{const t=D({filter:a,query:r,page:e.toString()});return`${window.location.pathname}?${t}`})(o);return p`<a .href=${c} .className=${`${s?"not-selectable":""} ${i?"active":""}`}>${n}</a>`};const o=n(p`<i class="material-icons">keyboard_double_arrow_left</i>`,1),s=n(p`<i class="material-icons">chevron_left</i>`,e-1),i=function(){const a=Math.floor(O.relativePageLinks/2),r=Math.min(Math.max(1,e-a),Math.max(1,t-O.relativePageLinks+1)),n=Math.max(Math.min(t,e+a),Math.min(t,O.relativePageLinks)),o=Math.min(n-r+1,t);return Array.from({length:o},((e,t)=>r+t))}().map((e=>n(e,e))),c=n(p`<i class="material-icons">chevron_right</i>`,e+1),l=n(p`<i class="material-icons">keyboard_double_arrow_right</i>`,t);return p`${o}${s}${i}${c}${l}`},Ae=(e,t)=>e.length>0?Re(e,t):p`<p class="empty">Нямаш завършени ремонти!</p>`,Re=(e,t)=>{var a;const r=!!(null==(a=X())?void 0:a.isSuperUser);return p`<table role="table"><thead role="rowgroup"><tr role="row"><th role="columnheader">Извършен на</th><th role="columnheader">Километри</th><th role="columnheader">Детайли по ремонта</th>${r?p`<th role="columnheader">Изтриване</th>`:b}</tr></thead><tbody role="rowgroup">${e.map((e=>Pe(e,r,t)))}</tbody></table>`},Pe=(e,t,a)=>p`<tr role="row"><td role="cell" data-cell-content="Извършен на">${E(e.date)}</td><td role="cell" data-cell-content="Километри">${e.km}</td><td role="cell" data-cell-content="Детайли по ремонта"><div class="buttons"><a role="button" data-button-type="info" href="${m.base()}/cars/${e.car.objectId}/repairs/${e.objectId}">Детайли</a></div></td>${t?Le(e,a):b}</tr>`,Le=(e,t)=>p`<td role="cell" data-cell-content="Изтриване"><div class="buttons"><button data-button-type="danger" @click=${a=>t(a,e)}><i class="material-icons">delete_forever</i></button></div></td>`,Ee=(e,t)=>{const a=(a,r)=>{const n=e===r||r<1||r>t,o="number"==typeof a&&e===r,s=n?"#":(e=>{const t=D({page:e.toString()});return`${window.location.pathname}?${t}`})(r);return p`<a .href=${s} .className=${`${n?"not-selectable":""} ${o?"active":""}`}>${a}</a>`};const r=a(p`<i class="material-icons">keyboard_double_arrow_left</i>`,1),n=a(p`<i class="material-icons">chevron_left</i>`,e-1),o=function(){const a=Math.floor(O.relativePageLinks/2),r=Math.min(Math.max(1,e-a),Math.max(1,t-O.relativePageLinks+1)),n=Math.max(Math.min(t,e+a),Math.min(t,O.relativePageLinks)),o=Math.min(n-r+1,t);return Array.from({length:o},((e,t)=>r+t))}().map((e=>a(e,e))),s=a(p`<i class="material-icons">chevron_right</i>`,e+1),i=a(p`<i class="material-icons">keyboard_double_arrow_right</i>`,t);return p`${r}${n}${o}${s}${i}`},Te="today";function je(e,t){e.preventDefault();m.base(`/Car-Service/admin/${t.objectId}`),m.redirect("/cars")}async function Oe(e,t){const a=(e,t)=>!t||!t.startDate||e>=t.startDate&&(!t.endDate||e<=t.endDate),r=(await async function(e){const t=e?{limit:"9999"}:void 0;return(await _(G.ALL_REPAIRS(t))).results}(!0)).sort(((e,t)=>{const a=new Date(e.createdAt),r=new Date(t.createdAt);return Number(r)-Number(a)})),n=me(t),o=me(e);return r.reduceRight(((e,t)=>{const r=new Date(t.date),s=t.owner.username;return a(r,n)&&(e.count[s]||(e.count[s]=0),e.count[s]++),a(r,o)&&(e.profit[s]||(e.profit[s]=0),e.profit[s]+=parseFloat(t.profit||"0")),e}),{count:{},profit:{}})}async function qe(e){e.preventDefault();const t=e.target,[a,r]=S(t);try{r(!0),U.showLoading({type:"cube-zoom"});const e=await async function(e){const t=await C(W.LOGIN,e),{result:a}=t,r=a.roles.includes("Admin");return await Q({username:e.username,id:a.objectId,token:a.sessionToken,isSuperUser:r}),H(),{isSuperUser:r,...a}}(a),t=e.isSuperUser?"/admin":"/cars";m.redirect(t)}catch(n){const e=n instanceof Error?n.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{r(!1),U.hideLoading(),t.reset()}}function Me(e){e.preventDefault();const t=e.target,a=t.previousElementSibling,r="password"===a.type?"text":"password";a.setAttribute("type",r),t.textContent="password"===r?"visibility_off":"visibility"}async function Ve(e){e.preventDefault();const t=e.target,[{username:a,password:r,repass:n},o]=S(t);if(r===n)try{o(!0),U.showLoading({type:"cube-zoom"}),await async function(e){const t=await C(W.REGISTER,e);return await Q({username:e.username,id:t.objectId,token:t.sessionToken}),H(),{username:e.username,updatedAt:t.createdAt,roles:[],...t}}({username:a,password:r}),m.redirect("/cars")}catch(s){const e=s instanceof Error?s.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{o(!1),U.hideLoading(),t.reset()}else U.showToast({text:"Паролите не съвпадат!",type:"warning"})}function ze(e){var t,a,r;e.preventDefault();const n=e.target,o=n.previousElementSibling,s=null==(r=null==(a=null==(t=n.parentElement)?void 0:t.parentElement)?void 0:a.nextElementSibling)?void 0:r.lastElementChild,i="password"===o.type?"text":"password";o.setAttribute("type",i),s.setAttribute("type",i),n.textContent="password"===i?"visibility_off":"visibility"}function Ue(e){e.preventDefault();const t=document.getElementById("search-options").value.trim(),a=document.getElementById("search-input").value.trim();t&&a?m.redirect(`/cars?${D({filter:t,query:a})}`):m.redirect("/cars")}async function Je(e,t){e.preventDefault();if(await new Promise((e=>U.showModal({message:`Сигурен ли си, че искаш да изтриеш автомобила на ${t.customerName} - "${t.registration}"`,onConfirm:()=>e(!0),onCancel:()=>e(!1)}))))try{U.showLoading(),await Promise.all([oe(t.objectId),te(t.objectId)]),U.showToast({text:`Успешно изтрихте автомобила на ${t.customerName} - "${t.registration}"`,type:"info"})}catch(a){const e=a instanceof Error?a.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{U.hideLoading(),m.redirect("/cars")}}class Be{constructor(e={}){this._doc=new y(e),Object.assign(this,this._doc)}async applyFont(){const e=await async function(e){if(I.has(e))return I.get(e);const t=await fetch(`/Car-Service/assets/fonts/${e}`,{mode:"no-cors"}),a=await t.blob(),r=await new Promise(((e,t)=>{const r=new FileReader;r.readAsDataURL(a),r.onloadend=()=>e(r.result),r.onerror=t})),n=e.split(".").pop(),o=r.slice(`data:font/${n};base64,`.length);return I.set(e,o),o}("Roboto-Regular.ttf");this._doc.addFileToVFS("Roboto-Regular.ttf",e),this._doc.addFont("Roboto-Regular.ttf","Roboto","normal"),this._doc.setFont("Roboto")}addHeader(){return this._doc.text("Автомобилен сервиз",105,10,{align:"center"}),this._doc.setFontSize(14),this._doc.text('ул. "Цар Симеон" 99',105,16,{align:"center"}),this._doc.text("София, България",105,22,{align:"center"}),this._doc.text("Телефон: 0888 888 888",105,28,{align:"center"}),this._doc.setFontSize(16),this}addFooter(){return this._doc.setFontSize(12),this._doc.text("Предаващ: ........................",20,285,{align:"left"}),this._doc.text("Получател: ........................",140,285,{align:"left"}),this}generateCarTable(e,t={}){return v(this._doc,{theme:"grid",head:[["Име на клиента","VIN","Pегистрационен номер","Марка / Модел","Двигател"]],body:e,margin:{top:45},styles:{font:"Roboto",textColor:[35,68,101]},headStyles:{fillColor:[35,68,101],textColor:255},alternateRowStyles:{fillColor:[238,238,238]},tableLineWidth:.5,tableLineColor:[35,68,101],...t}),this}generateRepairTable(e,t={}){return v(this._doc,{theme:"grid",head:[["Дата на ремонт","Постъпващи километри","Дължима сума","Забележка"]],body:e,margin:{top:45},styles:{font:"Roboto",textColor:[35,68,101]},headStyles:{fillColor:[35,68,101],textColor:255},alternateRowStyles:{fillColor:[238,238,238]},tableLineWidth:.5,tableLineColor:[35,68,101],...t}),this}}async function Fe(e,t,a){if(e.preventDefault(),!t||!(null==a?void 0:a.length))return;const r=[[t.customerName,t.vin,t.registration,t.make,t.engine]],n=a.map((e=>[j(e.date),`${e.km} km`,L(e.profit),e.description])),o=new Be;await o.applyFont(),o.addHeader().generateCarTable(r).generateRepairTable(n).addFooter().save(`Всични ремонти на ${t.customerName}.pdf`)}async function He(e,t){e.preventDefault();if(await new Promise((e=>U.showModal({message:`Сигурен ли си, че искаш да изтриеш ремонта от дата ${E(t.date)}`,onConfirm:()=>e(!0),onCancel:()=>e(!1)}))))try{U.showLoading(),await async function(e,t){var a;const r=await k(G.REPAIR_BY_ID(t)),n=`/cars/${e}/repairs`,o=(null!=(a=await q.getCacheData(n))?a:[]).filter((e=>e.objectId!==t));return await(o.length>0?q.updateCacheData(n,JSON.parse(JSON.stringify(o))):q.clearCacheData(n)),r}(t.car.objectId,t.objectId),U.showToast({text:"Успешно изтрихте ремонта",type:"info"})}catch(a){const e=a instanceof Error?a.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{U.hideLoading(),m.redirect(`/cars/${t.car.objectId}/repairs`)}}null==(s=document.getElementById("logout-button"))||s.addEventListener("click",(async function(e){if(e.preventDefault(),await new Promise((e=>U.showModal({message:"Сигурен ли си, че искаш да излезеш от профила си?",title:"Изход",onConfirm:()=>e(!0),onCancel:()=>e(!1)}))))try{U.showLoading({type:"cube-zoom"}),await async function(){const e=await C(W.LOGOUT,{});return await Z(),H(),e}(),m.base("/Car-Service"),m.redirect("/user/login")}catch(t){const e=t instanceof Error?t.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{U.hideLoading()}})),m.base("/Car-Service"),m((function(e,t){const a=Object.assign(e,{root:se,render:ue});!function(e){const{origin:t,pathname:a,search:r}=window.location,n=t+e.pathname,o=le.some((e=>a.endsWith(e))),s=X();if(s&&s.isSuperUser){const t=e.pathname.match(/\/admin\/([^/]+)/);t&&(e.params.userId=t[1])}o&&n!==t+a&&(e.state.prev=a+r)}(a),function(e){const{path:t}=e,a="interactive-widget=resizes-content";if(!ie){const e=document.createElement("meta");return e.name="viewport",e.content=a,void document.head.appendChild(e)}const r=ie.content.split(",").map((e=>e.trim()));ce.includes(t)&&!r.includes(a)?r.push(a):!ce.includes(t)&&r.includes(a)&&r.splice(r.indexOf(a),1);ie.content=r.join(", ")}(a),H(a),function(e){if(!e)return;if(!document.startViewTransition)return void e();document.startViewTransition(e)}((()=>{const a=X(),r=!a&&!ce.includes(e.path),n=a&&ce.includes(e.path),o=!(null==a?void 0:a.isSuperUser)&&de.some((t=>e.path.includes(t)));r?e.page.redirect(ce[0]):o||n?window.history.back():t()}))})),m("/user/login",(function(e){e.render(p`<section id="auth-page"><form @submit=${qe}><fieldset class="input-fields"><legend>Вход</legend><div class="field"><label for="user__username">Потребителско име: <span class='required'>*</span></label><input name="username" id="user__username" type="text" placeholder="Въведи потребителско име..." autocomplete="username" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="user__password">Парола: <span class='required'>*</span></label><div class="password-field"><input name="password" id="user__password" type="password" placeholder="Въведи парола..."     autocomplete="current-password" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /><i class="material-icons eye-icon" @click=${Me}>visibility_off</i></div></div><div class="buttons"><input role="button" data-button-type="info" type="submit" value="Вход" /></div><div class="form-link"><span>Все още нямаш профил? <a href="${m.base()}/user/register">Регистрирай се</a></span></div></fieldset></form></section>`)})),m("/user/register",(function(e){e.render(p`<section id="auth-page"><form @submit=${Ve}><fieldset class="input-fields"><legend>Регистрация</legend><div class="field"><label for="user__username">Потребителско име: <span class='required'>*</span></label><input name="username" id="user__username" type="text" placeholder="Въведи потребителско име..." required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="user__password">Парола: <span class='required'>*</span></label><div class="password-field"><input name="password" id="user__password" type="password" placeholder="Въведи парола..." required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /><i class="material-icons eye-icon" @click=${ze}>visibility_off</i></div></div><div class="field"><label for="user__repass">Потвърди паролата: <span class='required'>*</span></label><input name="repass" id="user__repass" type="password" placeholder="Повтори паролата..." required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="buttons"><input role="button" data-button-type="info" type="submit" value="Регистрация" /></div><div class="form-link"><span>Вече имаш създаден профил? <a href="${m.base()}/user/login">Вход</a></span></div></fieldset></form></section>`)})),m("/admin",(async function(e){m.base("/Car-Service");const{page:t="1",userProfit:a,userRepairs:r}=N(e.querystring);e.render(h((async()=>{const e=await async function(e,t=Te,a=Te){try{const[{results:r,count:n},o]=await Promise.all([K(e),Oe(t,a)]);return{users:r,numberOfUsers:n,repairs:o,pageNumber:e,userProfit:t,userRepairs:a}}catch(r){const e=r instanceof Error?r.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{U.hideLoading()}}(Number(t),a,r);if(e)return(e=>{const{users:t,numberOfUsers:a,repairs:r,pageNumber:n,userProfit:o,userRepairs:s,onBrowseAsUser:i,onRangeSelect:c}=e,l=Math.max(Math.ceil(a/O.usersPerPage),1);return p`<section id="admin-page"><span class="title">Aдминистраторско табло</span><div class="container"><div class="chart">${ye(c,"userRepairs",s)}${he(Object.keys(r.count),Object.values(r.count))}</div><div class="chart">${ye(c,"userProfit",o)}${be(Object.keys(r.profit),Object.values(r.profit))}</div></div>${ve(t,i)}<div class="pagination">${$e(n,l)}</div></section>`})({...e,onBrowseAsUser:je,onRangeSelect:(e,t)=>function(e,t,a){e.preventDefault();const r=e.target.value,n=me(r);r!==Te&&n?a[t]=r:delete a[t];const o=D(a);o?m.redirect(`/admin?${o}`):m.redirect("/admin")}(e,t,{userProfit:a,userRepairs:r})})})(),U.showLoading()))})),m(["/cars","/admin/:userId/cars"],(function(e){const{page:t="1",filter:a="",query:r=""}=N(e.querystring);e.render(h((async()=>{const n=await async function(e,t,a,r){try{const{results:n,count:o}=await async function(e,t,a,r){const n=t&&a?{[t]:{$regex:`(?i)${a}`}}:null,o=r?{owner:{__type:"Pointer",className:"_User",objectId:r}}:null,s=JSON.stringify({...n,...o}),i="/cars",c=await q.getCacheData(i);let l;if(n?({results:l}=await _(Y.ALL_CARS(s))):(l=null!=c?c:(await _(Y.ALL_CARS(s))).results,c||await q.updateCacheData(i,l)),!e)return{results:l,count:l.length};const d=(e-1)*O.itemsPerPage,u=e*O.itemsPerPage;return{results:l.slice(d,u),count:l.length}}(e,t,a,r);return{cars:n,carsCount:o,pageNumber:e,searchCategory:t,searchQuery:a}}catch(n){const e=n instanceof Error?n.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"}),m.redirect("/")}finally{U.hideLoading()}}(Number(t)||1,a,r,e.params.userId);if(n)return(e=>{var t,a,r;const{cars:n,carsCount:o,pageNumber:s,searchCategory:i,searchQuery:c,onSearch:l,onDelete:d}=e,u=Math.max(Math.ceil(o/O.itemsPerPage),1),m=!!(null==(t=X())?void 0:t.isSuperUser),f=null==(r=null==(a=n[0])?void 0:a.owner)?void 0:r.username;return p`<section id="catalog-page"><form autocomplete="off"><fieldset><legend>Всички автомобили${m&&f?` на "${f}"`:""}</legend><fieldset class="search"><label for="search-options" id="search-label" aria-hidden="true">Търсачка</label><select id="search-options" aria-labelledby="search-label"><option value="registration" .selected=${"registration"===i}>Регистрационен &numero;</option><option value="make" .selected=${"make"===i}>Марка</option><option value="engine" .selected=${"engine"===i}>Двигател</option><option value="customerName" .selected=${"customerName"===i}>Име на клиента</option></select><input id="search-input" type="search" placeholder="Въведи..." .value=${c} /><button @click=${l}>Търси</button></fieldset>${ke(n,d)}<fieldset class="pagination">${Se(s,u,i,c)}</fieldset></fieldset></form></section>`})({...n,onSearch:Ue,onDelete:Je})})(),U.showLoading()))})),m(["/cars/create","/admin/:userId/cars/create"],(function(e){const{prev:t=`${m.base()}/cars`}=e.state;e.render((e=>{const{prev:t,onSubmit:a}=e;return p`<section id="create-page"><form @submit=${a} autocomplete="off"><fieldset><legend>Добави автомобил</legend><fieldset class="input-fields"><div class="field"><label for="car__vin">VIN: <span class='required'>*</span></label><input name="vin" id="car__vin" type="text" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="car__registration">Pегистрационен &numero;: <span class='required'>*</span></label><input name="registration" id="car__registration" type="text" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="car__make">Марка / Модел:</label><input name="make" id="car__make" type="text" /></div><div class="field"><label for="car__engine">Двигател:</label><input name="engine" id="car__engine" type="text" /></div><div class="field"><label for="car__customer">Име на клиента: <span class='required'>*</span></label><input name="customerName" id="car__customer" type="text" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div></fieldset><div class="buttons"><button data-button-type="success" type="submit">Добави</button><a role="button" data-button-type="danger" href="${t}">Отказ</a></div></fieldset></form></section>`})({prev:t,onSubmit:t=>async function(e,t){e.preventDefault();const a=e.target,[r,n]=S(a);try{n(!0),U.showLoading(),await async function(e,t){var a;const{id:r}=t?{id:t}:X(),n={owner:Object.freeze({__type:"Pointer",className:"_User",objectId:r})},o=Object.assign({},e,n),s=await C(Y.CREATE_CAR,o),i="/cars",c=null!=(a=await q.getCacheData(i))?a:[],l={...o,...s};if(t)return l;const d=[l,...c].sort(((e,t)=>+new Date(t.createdAt)-+new Date(e.createdAt)));return await q.updateCacheData(i,JSON.parse(JSON.stringify(d))),l}(r,t),U.showToast({text:`Успешно създадохте автомобил на ${r.customerName} - "${r.registration}"`,type:"success"})}catch(o){const e=o instanceof Error?o.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{n(!1),U.hideLoading(),a.reset(),m.redirect("/cars")}}(t,e.params.userId)}))})),m(["/cars/:carId/edit","admin/:userId/cars/:carId/edit"],(function(e){const{carId:t}=e.params,{prev:a=`${m.base()}/cars`}=e.state;e.render(h((async()=>{const e=await async function(e){try{return await ee(e)}catch(t){const e=t instanceof Error?t.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"}),m.redirect("/cars")}finally{U.hideLoading()}}(t);if(e)return(e=>{const{car:t,prev:a,onSubmit:r}=e;return p`<section id="edit-page"><form @submit=${r} autocomplete="off"><fieldset><legend>Редактирай автомобил</legend><fieldset class="input-fields"><div class="field"><label for="car__vin">VIN: <span class='required'>*</span></label><input name="vin" id="car__vin" type="text" .value=${t.vin} required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="car__registration">Pегистрационен &numero;: <span class='required'>*</span></label><input name="registration" id="car__registration" type="text" .value=${t.registration} required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="car__make">Марка / Модел:</label><input name="make" id="car__make" type="text" .value=${t.make} /></div><div class="field"><label for="car__engine">Двигател:</label><input name="engine" id="car__engine" type="text" .value=${t.engine} /></div><div class="field"><label for="car__customer">Име на клиента: <span class='required'>*</span></label><input name="customerName" id="car__customer" type="text" .value=${t.customerName} required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div></fieldset><div class="buttons"><button data-button-type="info" type="submit">Запази промените</button><a role="button" data-button-type="danger" href="${a}">Отказ</a></div></fieldset></form></section>`})({car:e,prev:a,onSubmit:t=>async function(e,t){e.preventDefault();const a=e.target,[r,n]=S(a);try{n(!0),U.showLoading(),await async function(e,t){var a;const r=await x(Y.CAR_BY_ID(e),t),n="/cars",o=null!=(a=await q.getCacheData(n))?a:[],s=o.findIndex((t=>t.objectId===e)),i={...-1!==s?o.splice(s,1)[0]:{},...t,...r},c=[i,...o].sort(((e,t)=>+new Date(t.createdAt)-+new Date(e.createdAt)));return await q.updateCacheData(n,JSON.parse(JSON.stringify(c))),i}(t.objectId,r),U.showToast({text:`Успешно редактирахте ремонт на ${r.customerName} - "${r.registration}"`,type:"info"})}catch(o){const e=o instanceof Error?o.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{n(!1),U.hideLoading(),a.reset(),m.redirect("/cars")}}(t,e)})})(),U.showLoading()))})),m(["/cars/:carId/repairs","admin/:userId/cars/:carId/repairs"],(function(e){const{carId:t}=e.params,{page:a="1"}=N(e.querystring),{prev:r=`${m.base()}/cars`}=e.state;e.render(h((async()=>{const e=await async function(e,t){try{const[{results:a,all:r},n]=await Promise.all([re(e,t),ee(e)]);return{repairs:a,allRepairs:r,car:n,pageNumber:t}}catch(a){const e=a instanceof Error?a.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"}),m.redirect("/cars")}finally{U.hideLoading()}}(t,Number(a)||1);if(e)return(e=>{const{repairs:t,allRepairs:a,car:r,pageNumber:n,prev:o,onExport:s,onDelete:i}=e,c=Math.max(Math.ceil(a.length/O.itemsPerPage),1);return p`<section id="catalog-page"><form autocomplete="off"><fieldset><legend>Всички ремонти на ${r.customerName} - рег. &numero; ${r.registration}</legend><fieldset class="search"><div class="buttons"><a role="button" data-button-type="success" href="${m.base()}/cars/${r.objectId}/repairs/create">Добави ремонт</a><button data-button-type="info" @click=${e=>s(e,r,a)}>Експорт</button><a role="button" href="${o}">Назад</a></div></fieldset>${Ae(t,i)}<fieldset class="pagination">${Ee(n,c)}</fieldset></fieldset></form></section>`})({...e,prev:r,onExport:Fe,onDelete:He})})(),U.showLoading()))})),m(["/cars/:carId/repairs/create","admin/:userId/cars/:carId/repairs/create"],(function(e){const{carId:t,userId:a}=e.params,{prev:r=`${m.base()}/cars/${t}/repairs`}=e.state;e.render((e=>{const{prev:t,onSubmit:a}=e;return p`<section id="create-page"><form @submit=${a} autocomplete="off"><fieldset><legend>Добави ремонт</legend><fieldset class="input-fields"><div class="field"><label for="repair__date">Датa на ремонта: <span class='required'>*</span></label><input name="date" id="repair__date" type="date" .value="${j()}" style="cursor: pointer;" required @click="${({target:e})=>e.showPicker()}" @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="repair__km">Километри: <span class='required'>*</span></label><input name="km" id="repair__km" type="number" required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="repair__profit">Дължима сума:</label><input name="profit" id="repair__profit" type="text" /></div><div class="field"><label for="repair__description">Забележка:</label><textarea data-scrollbar name="description" id="repair__description" @keyup="${({target:e})=>{e.scrollHeight>e.clientHeight&&e.style.setProperty("height",e.scrollHeight+"px")}}"></textarea></div></fieldset><div class="buttons"><button data-button-type="success" type="submit">Добави</button><a role="button" data-button-type="danger" href="${t}">Отказ</a></div></fieldset></form></section>`})({prev:r,onSubmit:e=>async function(e,t,a){e.preventDefault();const r=e.target,[n,o]=S(r);n.date=T(n.date);try{o(!0),U.showLoading(),await async function(e,t,a){var r;const{id:n}=a?{id:a}:X(),o={owner:Object.freeze({__type:"Pointer",className:"_User",objectId:n})},s={car:Object.freeze({__type:"Pointer",className:"Car",objectId:e})},i=Object.assign({},t,o,s),c=await C(G.CREATE_REPAIR,i),l=`/cars/${e}/repairs`,d=null!=(r=await q.getCacheData(l))?r:[],u={...i,...c},p=[u,...d].sort(ae);return await q.updateCacheData(l,JSON.parse(JSON.stringify(p))),u}(t,n,a),U.showToast({text:"Успешно добавихте ремонт",type:"success"})}catch(s){const e=s instanceof Error?s.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{o(!1),U.hideLoading(),r.reset(),m.redirect(`/cars/${t}/repairs`)}}(e,t,a)}))})),m(["/cars/:carId/repairs/:repairId","admin/:userId/cars/:carId/repairs/:repairId"],(function(e){const{carId:t,repairId:a}=e.params,{prev:r=`${m.base()}/cars/${t}/repairs`}=e.state;e.render(h((async()=>{const e=await async function(e,t){try{return await ne(e,t)}catch(a){const t=a instanceof Error?a.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:t,type:"error"}),m.redirect(`/cars/${e}/repairs`)}finally{U.hideLoading()}}(t,a);if(e)return(e=>{const{repair:t,prev:a,onExport:r}=e;return p`<section id="details-page"><form autocomplete="off"><fieldset><legend>Детайли по ремонта</legend><fieldset class="search"><div class="buttons"><a role="button" data-button-type="info" href="${m.base()}/cars/${t.car.objectId}/repairs/${t.objectId}/edit">Редактирай</a><button data-button-type="info" @click=${r}>Експорт</button><a role="button" href="${a}">Назад</a></div></fieldset><fieldset class="input-fields"><legend>Обща информация</legend><div class="field"><label for="repair__date">Датa на ремонта:</label><input disabled name="date" id="repair__date" .value=${E(t.date)} /></div><div class="field"><label for="repair__km">Километри:</label><input disabled name="km" id="repair__km" .value=${t.km} /></div><div class="field"><label for="repair__profit">Дължима сума:</label><input disabled name="profit" id="repair__profit" .value=${t.profit} /></div></fieldset><fieldset disabled class="input-fields"><legend>Информация за ремонта</legend><div class="field"><label for="repair__description">Забележка:</label><textarea data-scrollbar name="description" id="repair__description" .value=${t.description}></textarea></div></fieldset></fieldset></form></section>`})({repair:e,prev:r,onExport:t=>async function(e,t){if(e.preventDefault(),!t)return;const a=await ee(t.car.objectId);if(!a)return;const r=[[a.customerName,a.vin,a.registration,a.make,a.engine]],n=[[j(t.date),`${t.km} km`,L(t.profit),t.description]],o=new Be;await o.applyFont(),o.addHeader().generateCarTable(r).generateRepairTable(n).addFooter().save(`Ремонт на ${a.customerName} от ${j(t.date)}.pdf`)}(t,e)})})(),U.showLoading()))})),m(["/cars/:carId/repairs/:repairId/edit","admin/:userId/cars/:carId/repairs/:repairId/edit"],(function(e){const{carId:t,repairId:a}=e.params;e.render(h((async()=>{const e=await async function(e,t){try{return await ne(e,t)}catch(a){const t=a instanceof Error?a.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:t,type:"error"}),m.redirect(`/cars/${e}/repairs`)}finally{U.hideLoading()}}(t,a);if(e)return(e=>{const{repair:t,onSubmit:a}=e;return p`<section id="edit-page"><form @submit=${a} autocomplete="off"><fieldset><legend>Редактирай ремонт</legend><fieldset class="input-fields"><div class="field"><label for="repair__date">Датa на ремонта: <span class='required'>*</span></label><input name="date" id="repair__date" type="date" .value=${j(t.date)} style="cursor: pointer;" required @click="${({target:e})=>e.showPicker()}" @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="repair__km">Километри: <span class='required'>*</span></label><input name="km" id="repair__km" type="number" .value=${t.km} required @invalid="${({target:e})=>e.setCustomValidity("Полето е задължително!")}" @input="${({target:e})=>e.setCustomValidity("")}" /></div><div class="field"><label for="repair__profit">Дължима сума:</label><input name="profit" id="repair__profit" type="text" .value=${t.profit} /></div><div class="field"><label for="repair__description">Забележка:</label><textarea data-scrollbar name="description" id="repair__description" .value=${t.description} @keyup="${({target:e})=>{e.scrollHeight>e.clientHeight&&e.style.setProperty("height",e.scrollHeight+"px")}}"></textarea></div></fieldset><div class="buttons"><button data-button-type="success" type="submit">Запази промените</button><a role="button" data-button-type="danger" href="${m.base()}/cars/${t.car.objectId}/repairs/${t.objectId}">Отказ</a></div></fieldset></form></section>`})({repair:e,onSubmit:t=>async function(e,t){e.preventDefault();const a=e.target,[r,n]=S(a),o=r.date;r.date=T(r.date);try{n(!0),U.showLoading(),await async function(e,t,a){var r;const n=await x(G.REPAIR_BY_ID(t),a),o=`/cars/${e}/repairs`,s=null!=(r=await q.getCacheData(o))?r:[],i=s.findIndex((e=>e.objectId===t)),c={...-1!==i?s.splice(i,1)[0]:{},...a,...n},l=[c,...s].sort(ae);return await q.updateCacheData(o,JSON.parse(JSON.stringify(l))),c}(t.car.objectId,t.objectId,r),U.showToast({text:`Успешно редактирахте ремонт от дата "${o}"`,type:"info"})}catch(s){const e=s instanceof Error?s.message:"Възникна грешка, моля опитайте по-късно";U.showToast({text:e,type:"error"})}finally{n(!1),U.hideLoading(),a.reset(),m.redirect(`/cars/${t.car.objectId}/repairs/${t.objectId}`)}}(t,e)})})(),U.showLoading()))})),m.start();
